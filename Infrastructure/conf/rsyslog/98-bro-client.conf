#################################################### BRO logs ####################################################
action(type="mmjsonparse")

ruleset(name="bro") {
    # Extract log filename
    set $.suffix=re_extract($!metadata!filename, "(.*)/([^/].*[^/.log])", 0, 2, "all.log");
    call sendToLogserver
}

input(type="imfile"
    file="/opt/bro/logs/current/*.log"
    tag="tor-bro__"
    ruleset="bro"
    addmetadata="on"
)

template (
    name="LongTagForwardFormat"
    type="string"
    string="<%PRI%>%TIMESTAMP:::date-rfc3339% %HOSTNAME% %syslogtag%%$.suffix%%msg:::sp-if-no-1st-sp%%msg%"
)

ruleset(name="sendToLogserver") {
    action(
        type="omrelp"
        Target="{{ hostname }}.{{ base_domain }}"
        Port="{{ rsyslog_port }}"
        tls="{{ rsyslog_tls }}"
        Template="LongTagForwardFormat"
    )
}